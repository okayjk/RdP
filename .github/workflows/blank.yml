name: Windows RDP (Brute Force Fix)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Download Bore
      run: Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip -OutFile bore.zip

    - name: Extract Bore
      run: Expand-Archive bore.zip -DestinationPath .

    - name: Brute Force Firewall & RDP
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        # Brute force the firewall for port 3389
        netsh advfirewall firewall add rule name="Allow RDP" dir=in action=allow protocol=TCP localport=3389
        # Disable NLA (Network Level Authentication) which causes mobile connection issues
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0

    - name: Set Password
      run: |
        $pass = ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pass

    - name: Start Bore
      run: |
        Start-Process -FilePath ".\bore.exe" -ArgumentList "local 3389 --to bore.pub" -RedirectStandardOutput "bore.log"

    - name: Get Connection Info
      run: |
        Write-Host "Waiting 30 seconds for stable connection..."
        Start-Sleep -Seconds 30
        $log = Get-Content bore.log
        $port_line = $log | Select-String "listening at bore.pub"
        if ($port_line) {
            $port = $port_line.ToString().Split(":")[-1].Trim()
            Write-Host "::notice::ADDRESS: bore.pub:$port"
        } else {
            Get-Content bore.log
            exit 1
        }

    - name: Keep Alive
      run: while ($true) { Start-Sleep -Seconds 60 }
