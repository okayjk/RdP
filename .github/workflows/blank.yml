name: Windows RDP (Force-Start)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Download Bore
      run: Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip -OutFile bore.zip

    - name: Extract Bore
      run: Expand-Archive bore.zip -DestinationPath .

    - name: Force Start RDP Service
      run: |
        # Enable RDP in Registry
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0
        
        # Open Firewall for all profiles
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        netsh advfirewall firewall add rule name="Bore_RDP" dir=in action=allow protocol=TCP localport=3389
        
        # Force Restart the Remote Desktop Service
        Restart-Service -Force -Name TermService
        
        # Check if Port 3389 is actually listening now
        $check = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
        if ($check) { Write-Host "SUCCESS: Port 3389 is now listening!" }
        else { Write-Error "ERROR: Port 3389 is STILL NOT listening." }

    - name: Set Password
      run: |
        $pass = ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pass

    - name: Start Bore
      run: |
        Start-Process -FilePath ".\bore.exe" -ArgumentList "local 3389 --to bore.pub" -RedirectStandardOutput "bore.log"

    - name: Get Connection Info
      run: |
        Write-Host "Waiting 30 seconds for Bore..."
        Start-Sleep -Seconds 30
        $log = Get-Content bore.log
        $port_line = $log | Select-String "listening at bore.pub"
        if ($port_line) {
            $port = $port_line.ToString().Split(":")[-1].Trim()
            Write-Host "::notice::========================================"
            Write-Host "::notice::RDP ADDRESS: bore.pub:$port"
            Write-Host "::notice::========================================"
        } else {
            Get-Content bore.log
            exit 1
        }

    - name: Keep Alive
      run: while ($true) { Start-Sleep -Seconds 60 }
