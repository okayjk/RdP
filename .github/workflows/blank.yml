name: Windows RDP (Final Fix)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Download Cloudflared
      run: Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile cloudflared.exe

    - name: Force Start RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        Restart-Service -Force -Name TermService

    - name: Set Password
      run: |
        $pass = ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pass

    - name: Start Tunnel
      run: |
        # Start tunnel and wait longer for the link to generate
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -RedirectStandardError "tunnel.log"

    - name: GET REAL HOSTNAME
      run: |
        Write-Host "Searching for your unique link..."
        # Wait 45 seconds to ensure the link is generated
        Start-Sleep -Seconds 45
        $log = Get-Content tunnel.log
        
        # This search looks for the specific 'https://' link in the logs
        $url = $log | Select-String -Pattern "https://[a-zA-Z0-9-.]+.trycloudflare.com" | Select-Object -First 1
        
        if ($url) {
            $clean_url = ($url.Matches.Value).Replace("https://", "")
            Write-Host "::notice::========================================"
            Write-Host "::notice::COPY THIS ADDRESS: $clean_url"
            Write-Host "::notice::PORT: 443"
            Write-Host "::notice::========================================"
        } else {
            Write-Host "Link not found yet. Printing full log to find it manually:"
            Get-Content tunnel.log
        }

    - name: Keep Alive
      run: while ($true) { Start-Sleep -Seconds 60 }
