name: Windows RDP (Bore - No Account)

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Download Bore
      run: Invoke-WebRequest https://github.com/ekzhang/bore/releases/download/v0.5.0/bore-v0.5.0-x86_64-pc-windows-msvc.zip -OutFile bore.zip

    - name: Extract Bore
      run: Expand-Archive bore.zip -DestinationPath .

    - name: Enable RDP & Firewall
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

    - name: Set Admin Password
      run: |
        $pass = ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force
        Set-LocalUser -Name "runneradmin" -Password $pass

    - name: Start Bore Tunnel
      run: |
        # Start Bore in the background
        # It connects to the public 'bore.pub' server
        Start-Process -FilePath ".\bore.exe" -ArgumentList "local 3389 --to bore.pub" -RedirectStandardOutput "bore.log" -PassThru

    - name: Get Connection Info
      run: |
        Write-Host "Waiting for tunnel connection..."
        Start-Sleep -Seconds 5
        
        # Read the log to find the port number
        $log = Get-Content bore.log
        $port_line = $log | Select-String "listening at bore.pub"
        
        if ($port_line) {
            # Extract just the port number
            $port = $port_line.ToString().Split(":")[-1].Trim()
            
            Write-Host "::notice::SUCCESS! CONNECT NOW!"
            Write-Host "::notice::---------------------------------------"
            Write-Host "::notice::Address:  bore.pub:$port"
            Write-Host "::notice::User:     runneradmin"
            Write-Host "::notice::Pass:     P@ssw0rd!"
            Write-Host "::notice::---------------------------------------"
        } else {
            Write-Error "Could not get port. Check logs."
            Get-Content bore.log
        }

    - name: Keep Alive
      run: |
        Write-Host "Session is active. Press Cancel Workflow to stop."
        while ($true) {
          Start-Sleep -Seconds 60
        }
